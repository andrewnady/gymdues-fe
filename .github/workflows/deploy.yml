name: Build and Deploy Next.js

on:
  push:
    branches:
      - dev
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8.15.3

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint

      - name: Type check
        run: pnpm run type-check

      - name: Build application
        run: pnpm run build:production
        env:
          NODE_ENV: production

      - name: Create deployment package
        run: |
          # 1. Prepare directory
          mkdir -p deploy

          # 2. Copy Standalone Output (This contains server.js and minimal node_modules)
          # Note: We rely on Next.js to package the logic correctly.
          cp -r .next/standalone/* deploy/

          # 3. Copy Static Assets (Next.js Standalone excludes these by default)
          # We must manually copy .next/static to deploy/.next/static
          mkdir -p deploy/.next/static
          cp -r .next/static/* deploy/.next/static/

          # 4. Copy Public Folder (Images, fonts, etc.)
          cp -r public deploy/ 2>/dev/null || true

          # 5. Copy Environment Variables
          if [ -f .env.production ]; then
            cp .env.production deploy/.env
          elif [ -f .env ]; then
            cp .env deploy/.env
          fi
          
          # 6. Verify Critical Files
          echo "=== Verifying deployment package ==="
          [ -f "deploy/server.js" ] && echo "✓ server.js exists" || { echo "✗ server.js missing"; exit 1; }
          [ -d "deploy/.next/static" ] && echo "✓ static assets exist" || { echo "✗ static assets missing"; exit 1; }

          # 7. Compress
          tar -czf deploy.tar.gz -C deploy .

      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deploy.tar.gz
          retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Download deployment package
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: .

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add host to known_hosts to avoid interactive prompt
          ssh-keyscan -H ${{ vars.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Server
        run: |
          # Upload tarball
          scp -i ~/.ssh/deploy_key deploy.tar.gz ${{ vars.DEPLOY_USER }}@${{ vars.DEPLOY_HOST }}:/tmp/
          
          # Execute commands on server
          ssh -i ~/.ssh/deploy_key ${{ vars.DEPLOY_USER }}@${{ vars.DEPLOY_HOST }} << 'EOF'
            set -e

            APP_DIR="${{ vars.DEPLOY_PATH }}"
            TEMP_DIR=$(mktemp -d)
            
            echo "Deploying to $APP_DIR..."

            # 1. Extract to temp location
            tar -xzf /tmp/deploy.tar.gz -C "$TEMP_DIR"
            
            # 2. Create destination if not exists
            mkdir -p "$APP_DIR"
            
            # 3. Backup (Optional: Keep one previous version)
            # If server.js exists, move current contents to backup
            # if [ -f "$APP_DIR/server.js" ]; then
            #    rm -rf "$APP_DIR.bak"
            #    cp -r "$APP_DIR" "$APP_DIR.bak"
            # fi

            # 4. Sync files (rsync is safer than cp for overwriting running apps, but cp works)
            # We copy contents of temp dir into app dir
            cp -r "$TEMP_DIR"/* "$APP_DIR/"
            
            # Copy dotfiles (.env, etc)
            cp -r "$TEMP_DIR"/.[!.]* "$APP_DIR/" 2>/dev/null || true

            # 5. Cleanup
            rm -rf "$TEMP_DIR" /tmp/deploy.tar.gz

            # 6. PM2 Process Management
            cd "$APP_DIR"
            
            # Ensure PM2 is installed globally or use npx
            if command -v pm2 &> /dev/null; then
              # Check if process exists
              if pm2 list | grep -q "gymdues-nextjs"; then
                echo "Reloading existing application..."
                pm2 reload gymdues-nextjs --update-env
              else
                echo "Starting new application..."
                # Next.js standalone typically listens on 3000 by default. 
                # PORT and HOSTNAME can be passed here if needed.
                pm2 start server.js --name "gymdues-nextjs"
              fi
              
              # Save PM2 list so it survives reboots
              pm2 save
            else
              echo "Error: PM2 is not installed on the server."
              exit 1
            fi

            echo "Deployment Successful!"
          EOF

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/deploy_key